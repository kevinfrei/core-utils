{"version":3,"sources":["../src/ClientRPC.js"],"names":["FTON","require","MakeTypedMessage","theMessage","msg","type","func","args","typecheck","result","undefined","InvokeFunc","handler","reply","get","ClientRPC","message","typedMsg","Array","isArray","module","exports"],"mappings":"AACA;AACA;;AAEA,MAAMA,IAAI,GAAGC,OAAO,CAAC,QAAD,CAApB;;AAIA,MAAMC,gBAAgB,GAAIC,UAAD,IAA2C;AAClE,QAAMC,GAAG,GAAGD,UAAZ;AACA,MAAI,CAACC,GAAL,EAAU;AAEV,MAAI,CAACA,GAAG,CAACC,IAAT,EAAe,OAAO,IAAP;AACf,QAAMA,IAAI,GAAGD,GAAG,CAACC,IAAjB;AACA,MAAIA,IAAI,KAAK,KAAb,EAAoB;AAEpB,MAAI,CAACD,GAAG,CAACE,IAAT,EAAe;AACf,QAAMA,IAAI,GAAGF,GAAG,CAACE,IAAjB;AACA,MAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAE9B,MAAIC,IAAc,GAAG,IAArB;AACA,MAAIH,GAAG,CAACG,IAAR,EAAcA,IAAI,GAAGP,IAAI,CAACQ,SAAL,CAAeJ,GAAG,CAACG,IAAnB,CAAP,CAboD,CAanB;;AAE/C,MAAIH,GAAG,CAACK,MAAJ,KAAeC,SAAnB,EAA8B;AAC5B,WAAO;AACLJ,MAAAA,IADK;AAELC,MAAAA;AAFK,KAAP;AAID;;AACD,MAAI,OAAOH,GAAG,CAACK,MAAX,KAAsB,QAA1B,EAAoC,OAAO,IAAP;AACpC,SAAO;AAAEH,IAAAA,IAAF;AAAQC,IAAAA,IAAR;AAAcE,IAAAA,MAAM,EAAEL,GAAG,CAACK;AAA1B,GAAP;AACD,CAvBD;;AAyBA,MAAME,UAAU,GAAG,CACjBL,IADiB,EAEjBC,IAFiB,EAGjBK,OAHiB,EAIjBH,MAJiB,KAKd;AACH,MAAI,CAACA,MAAL,EAAa;AACXH,IAAAA,IAAI,CAAC,GAAGC,IAAJ,CAAJ;AACD,GAFD,MAEO;AACL,UAAMM,KAAgB,GAAGD,OAAO,CAACE,GAAR,CAAYL,MAAZ,CAAzB;;AACA,QAAII,KAAJ,EAAW;AACTA,MAAAA,KAAK,CAACP,IAAI,CAAC,GAAGC,IAAJ,CAAL,CAAL;AACD;AACF;AACF,CAdD;;AAgBA,MAAMQ,SAAS,GAAG,CAACC,OAAD,EAAoBJ,OAApB,KAAsD;AACtE;AACA;AACA,QAAMK,QAAQ,GAAGf,gBAAgB,CAACc,OAAD,CAAjC;;AACA,MAAI,CAACC,QAAL,EAAe;AACb;AACD;;AACD,QAAMX,IAAe,GAAGM,OAAO,CAACE,GAAR,CAAYG,QAAQ,CAACX,IAArB,CAAxB;;AACA,MAAI,CAACA,IAAL,EAAW;AACT;AACD;;AACD,MAAIY,KAAK,CAACC,OAAN,CAAcF,QAAQ,CAACV,IAAvB,CAAJ,EAAkC;AAChCI,IAAAA,UAAU,CAACL,IAAD,EAAOW,QAAQ,CAACV,IAAhB,EAAsBK,OAAtB,EAA+BK,QAAQ,CAACR,MAAxC,CAAV;AACD,GAFD,MAEO,IAAIQ,QAAQ,CAACV,IAAb,EAAmB;AACxBI,IAAAA,UAAU,CAACL,IAAD,EAAO,CAACW,QAAQ,CAACV,IAAV,CAAP,EAAwBK,OAAxB,EAAiCK,QAAQ,CAACR,MAA1C,CAAV;AACD,GAFM,MAEA;AACLE,IAAAA,UAAU,CAACL,IAAD,EAAO,EAAP,EAAWM,OAAX,EAAoBK,QAAQ,CAACR,MAA7B,CAAV;AACD;AACF,CAlBD;;AAoBAW,MAAM,CAACC,OAAP,GAAiBN,SAAjB","sourcesContent":["//@flow\r\n//@format\r\n'use strict';\r\n\r\nconst FTON = require('./FTON');\r\n\r\nimport type { FTONData, rpcMessageType, rpcHandlerType } from './index';\r\n\r\nconst MakeTypedMessage = (theMessage: FTONData): ?rpcMessageType => {\r\n  const msg = theMessage;\r\n  if (!msg) return;\r\n\r\n  if (!msg.type) return null;\r\n  const type = msg.type;\r\n  if (type !== 'rpc') return;\r\n\r\n  if (!msg.func) return;\r\n  const func = msg.func;\r\n  if (typeof func !== 'string') return;\r\n\r\n  let args: FTONData = null;\r\n  if (msg.args) args = FTON.typecheck(msg.args); // WTF is wrong with you, Flow?\r\n\r\n  if (msg.result === undefined) {\r\n    return {\r\n      func,\r\n      args\r\n    };\r\n  }\r\n  if (typeof msg.result !== 'string') return null;\r\n  return { func, args, result: msg.result };\r\n};\r\n\r\nconst InvokeFunc = (\r\n  func: (...args:Array<mixed>) => mixed,\r\n  args: Array<any>,\r\n  handler: rpcHandlerType,\r\n  result: ?string\r\n) => {\r\n  if (!result) {\r\n    func(...args);\r\n  } else {\r\n    const reply: ?Function = handler.get(result);\r\n    if (reply) {\r\n      reply(func(...args));\r\n    }\r\n  }\r\n};\r\n\r\nconst ClientRPC = (message: FTONData, handler: rpcHandlerType): void => {\r\n  // Validate the message, then call the function\r\n  // by reflecting on the handler\r\n  const typedMsg = MakeTypedMessage(message);\r\n  if (!typedMsg) {\r\n    return;\r\n  }\r\n  const func: ?Function = handler.get(typedMsg.func);\r\n  if (!func) {\r\n    return;\r\n  }\r\n  if (Array.isArray(typedMsg.args)) {\r\n    InvokeFunc(func, typedMsg.args, handler, typedMsg.result);\r\n  } else if (typedMsg.args) {\r\n    InvokeFunc(func, [typedMsg.args], handler, typedMsg.result);\r\n  } else {\r\n    InvokeFunc(func, [], handler, typedMsg.result);\r\n  }\r\n};\r\n\r\nmodule.exports = ClientRPC;\r\n"],"file":"ClientRPC.js"}